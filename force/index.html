<!DOCTYPE html>
<html xmlns:xlink="http://www.w3.org/1999/xlink" lang="en">
<head>
<meta charset="utf-8">
<title>Force Layout with labels on edges</title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style type="text/css">
</style>
</head>
<body>

<script type="text/javascript">

    var w = 1900;
    var h = 1600;
    var linkDistance=150;

    var colors = d3.scale.category10();

    var dataset = {"graph": [], "multigraph": true, "nodes": [{"name": "Brayden", "id": "Brayden", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/38/"}, {"id": ""}, {"name": "The Lost Hastae", "id": "The Lost Hastae", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/48/"}, {"name": "Gaius Julius Caesar", "id": "Gaius Julius Caesar", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/26/"}, {"name": "The Child", "id": "The Child", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/13/"}, {"name": "Sons of Dagon", "id": "Sons of Dagon", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/56/"}, {"name": "Para", "id": "Para", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/32/"}, {"name": "Cariactus Nello", "id": "Cariactus Nello", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/53/"}, {"name": "Celt Warriors", "id": "Celt Warriors", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/8/"}, {"name": "Dreamer in the Deep", "id": "Dreamer in the Deep", "node_shape": "v", "url": "http://story-chronicles.herokuapp.com/storyobjects/82/"}, {"name": "Coricea", "id": "Coricea", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/62/"}, {"name": "Queen Mab", "id": "Queen Mab", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/51/"}, {"name": "Divicaicus", "id": "Divicaicus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/16/"}, {"name": "Hoab", "id": "Hoab", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/10/"}, {"name": "The Hastae", "id": "The Hastae", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/43/"}, {"name": "Logos of Ios", "id": "Logos of Ios", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/1/"}, {"name": "Hector", "id": "Hector", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/60/"}, {"name": "Morr", "id": "Morr", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/83/"}, {"name": "Dairmuid", "id": "Dairmuid", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/9/"}, {"name": "Hosidius", "id": "Hosidius", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/36/"}, {"name": "Marcus Crassus Jr.", "id": "Marcus Crassus Jr.", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/35/"}, {"name": "Ruffio Thrassus", "id": "Ruffio Thrassus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/78/"}, {"name": "The Red Wizards", "id": "The Red Wizards", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/45/"}, {"name": "Cogidubnus", "id": "Cogidubnus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/14/"}, {"name": "Vectis", "id": "Vectis", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/79/"}, {"name": "Great Old Ones", "id": "Great Old Ones", "node_shape": "v", "url": "http://story-chronicles.herokuapp.com/storyobjects/75/"}, {"name": "Marcus Antonius", "id": "Marcus Antonius", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/27/"}, {"name": "Fearghas Nerviorum", "id": "Fearghas Nerviorum", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/67/"}, {"name": "Wight Blade", "id": "Wight Blade", "node_shape": "s", "url": "http://story-chronicles.herokuapp.com/storyobjects/17/"}, {"name": "Oblius", "id": "Oblius", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/2/"}, {"name": "Atticus Galbo", "id": "Atticus Galbo", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/28/"}, {"name": "Colwyn", "id": "Colwyn", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/30/"}, {"name": "Kaeso Messor", "id": "Kaeso Messor", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/66/"}, {"name": "The Wolves", "id": "The Wolves", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/42/"}, {"name": "Cult of Mithras", "id": "Cult of Mithras", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/57/"}, {"name": "Bronwen White-Cloak", "id": "Bronwen White-Cloak", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/63/"}, {"name": "The Crawling Chaos", "id": "The Crawling Chaos", "node_shape": "v", "url": "http://story-chronicles.herokuapp.com/storyobjects/81/"}, {"name": "Ivy", "id": "Ivy", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/71/"}, {"name": "The Black Goat of the Woods", "id": "The Black Goat of the Woods", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/80/"}, {"name": "Shadow's Kiss", "id": "Shadow's Kiss", "node_shape": "s", "url": "http://story-chronicles.herokuapp.com/storyobjects/77/"}, {"name": "Yvarra", "id": "Yvarra", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/29/"}, {"name": "Gwynneth", "id": "Gwynneth", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/37/"}, {"name": "Dumnonia (D)", "id": "Dumnonia (D)", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/31/"}, {"name": "Stone Giants", "id": "Stone Giants", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/73/"}, {"name": "The Guild", "id": "The Guild", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/54/"}, {"name": "Marcus Caelius", "id": "Marcus Caelius", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/69/"}, {"name": "Salielgova", "id": "Salielgova", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/34/"}, {"name": "Legio VII - Victrix", "id": "Legio VII - Victrix", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/47/"}, {"name": "Orphans", "id": "Orphans", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/55/"}, {"name": "Mammura of Formiae", "id": "Mammura of Formiae", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/58/"}, {"name": "Quintus Sabinus", "id": "Quintus Sabinus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/59/"}, {"name": "Bethmella", "id": "Bethmella", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/65/"}, {"name": "Kalas", "id": "Kalas", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/33/"}, {"name": "Arun", "id": "Arun", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/15/"}, {"name": "Ancient Purple Worm", "id": "Ancient Purple Worm", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/19/"}, {"name": "Salvadar the Dwarf", "id": "Salvadar the Dwarf", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/76/"}, {"name": "Ancasta", "id": "Ancasta", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/52/"}, {"name": "Tempus", "id": "Tempus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/61/"}, {"name": "The Druids", "id": "The Druids", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/44/"}, {"name": "Thysania Agrippina", "id": "Thysania Agrippina", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/68/"}, {"name": "Beast in the Depths", "id": "Beast in the Depths", "node_shape": "^", "url": "http://story-chronicles.herokuapp.com/storyobjects/70/"}, {"name": "Siculus", "id": "Siculus", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/11/"}, {"name": "Lamplighters", "id": "Lamplighters", "node_shape": "h", "url": "http://story-chronicles.herokuapp.com/storyobjects/49/"}, {"name": "Ydrick Shadow-Brow", "id": "Ydrick Shadow-Brow", "node_shape": "o", "url": "http://story-chronicles.herokuapp.com/storyobjects/64/"}], "directed": true, "links": [{"target": 41, "label": "Comrade in Arms of", "source": 0, "key": 0, "weight": 5.0}, {"target": 2, "label": "Member of", "source": 6, "key": 0, "weight": 1}, {"target": 32, "label": "Has invested in", "source": 7, "key": 0, "weight": 8}, {"target": 44, "label": "Leads", "source": 7, "key": 0, "weight": 7}, {"target": 30, "label": "Warily accepting of", "source": 7, "key": 0, "weight": 4}, {"target": 26, "label": "Supplier to", "source": 7, "key": 0, "weight": 4}, {"target": 27, "label": "Has a tenuous alliance with", "source": 7, "key": 0, "weight": 3}, {"target": 13, "label": "Taught magic to", "source": 11, "key": 0, "weight": 6}, {"target": 45, "label": "Laid a geas upon", "source": 11, "key": 0, "weight": 5}, {"target": 13, "label": "Loves", "source": 12, "key": 0, "weight": 5.0}, {"target": 23, "label": "Respects", "source": 12, "key": 0, "weight": 5.0}, {"target": 58, "label": "Member of", "source": 12, "key": 0, "weight": 6}, {"target": 18, "label": "Is proud of", "source": 12, "key": 0, "weight": 5.0}, {"target": 11, "label": "Studied magic under", "source": 13, "key": 0, "weight": 5.0}, {"target": 18, "label": "Resents", "source": 13, "key": 0, "weight": 5.0}, {"target": 33, "label": "I will rip them  down", "source": 13, "key": 0, "weight": 6}, {"target": 47, "label": "Member of", "source": 15, "key": 0, "weight": 1}, {"target": 29, "label": "Distrusts", "source": 15, "key": 0, "weight": 4.5}, {"target": 62, "label": "Luminatus of", "source": 16, "key": 0, "weight": 4}, {"target": 59, "label": "Has a crush on", "source": 18, "key": 0, "weight": 3}, {"target": 12, "label": "Loves", "source": 18, "key": 0, "weight": 5.0}, {"target": 62, "label": "Member of", "source": 19, "key": 0, "weight": 1}, {"target": 5, "label": "Suspected member of", "source": 20, "key": 0, "weight": 4}, {"target": 45, "label": "Wishes to destroy", "source": 20, "key": 0, "weight": 5}, {"target": 47, "label": "Member of", "source": 20, "key": 0, "weight": 5}, {"target": 3, "label": "Looks up to", "source": 20, "key": 0, "weight": 6}, {"target": 14, "label": "Cautious of", "source": 20, "key": 0, "weight": 3}, {"target": 32, "label": "Arcane instructor of", "source": 21, "key": 0, "weight": 5}, {"target": 53, "label": "Trusts", "source": 23, "key": 0, "weight": 5.0}, {"target": 40, "label": "Passionately Loves", "source": 23, "key": 0, "weight": 9.9}, {"target": 61, "label": "Innately dislikes", "source": 26, "key": 0, "weight": 3}, {"target": 61, "label": "Belongs to", "source": 28, "key": 0, "weight": 5.0}, {"target": 45, "label": "Dislikes", "source": 29, "key": 0, "weight": 3}, {"target": 48, "label": "Member of", "source": 29, "key": 0, "weight": 3}, {"target": 23, "label": "Loves like a brother", "source": 31, "key": 0, "weight": 5.0}, {"target": 45, "label": "Ally", "source": 32, "key": 0, "weight": 8}, {"target": 14, "label": "Member of", "source": 32, "key": 0, "weight": 7}, {"target": 47, "label": "Ally", "source": 32, "key": 0, "weight": 6}, {"target": 54, "label": "Helped kill it", "source": 32, "key": 0, "weight": 1}, {"target": 26, "label": "Ally", "source": 32, "key": 0, "weight": 3}, {"target": 27, "label": "Ally", "source": 32, "key": 0, "weight": 7}, {"target": 59, "label": "Ally", "source": 32, "key": 0, "weight": 7}, {"target": 3, "label": "Patron and friend", "source": 32, "key": 0, "weight": 10}, {"target": 61, "label": "Ally", "source": 32, "key": 0, "weight": 7}, {"target": 37, "label": "Familiar", "source": 32, "key": 0, "weight": 5}, {"target": 51, "label": "Ally", "source": 32, "key": 0, "weight": 3}, {"target": 63, "label": "Protective towards", "source": 35, "key": 0, "weight": 6}, {"target": 33, "label": "Pack Leader of", "source": 35, "key": 0, "weight": 4}, {"target": 32, "label": "Familiar", "source": 37, "key": 0, "weight": 5}, {"target": 59, "label": "Gifted to", "source": 39, "key": 0, "weight": 6}, {"target": 23, "label": "Truly Loves", "source": 40, "key": 0, "weight": 7.0}, {"target": 61, "label": "Impressed by", "source": 41, "key": 0, "weight": 3}, {"target": 1, "label": "Leader of", "source": 42, "key": 0, "weight": 3}, {"target": 2, "label": "Member of", "source": 46, "key": 0, "weight": 1}, {"target": 26, "label": "Serves", "source": 48, "key": 0, "weight": 9}, {"target": 47, "label": "Legate of", "source": 50, "key": 0, "weight": 6}, {"target": 32, "label": "Feels comfortable with", "source": 51, "key": 0, "weight": 5}, {"target": 2, "label": "Member of", "source": 52, "key": 0, "weight": 2}, {"target": 56, "label": "Worried about", "source": 53, "key": 0, "weight": 5}, {"target": 39, "label": "Forged", "source": 55, "key": 0, "weight": 6}, {"target": 53, "label": "Devoted to", "source": 56, "key": 0, "weight": 5.0}, {"target": 2, "label": "Possessed and manipulated", "source": 60, "key": 0, "weight": 6}, {"target": 50, "label": "Psychically dominated", "source": 60, "key": 0, "weight": 8}, {"target": 23, "label": "Stole the kingdom of", "source": 60, "key": 0, "weight": 8}, {"target": 14, "label": "Member of", "source": 61, "key": 0, "weight": 3}, {"target": 28, "label": "Wields the", "source": 61, "key": 0, "weight": 9}, {"target": 59, "label": "Frenemy", "source": 61, "key": 0, "weight": 4}, {"target": 33, "label": "Durotrige Noble of", "source": 63, "key": 0, "weight": 2}]};

 
    var svg = d3.select("body").append("svg").attr({"width":w,"height":h});

    var force = d3.layout.force()
        .nodes(dataset.nodes)
        .links(dataset.links)
        .size([w,h])
        .linkDistance([linkDistance])
        .charge([-500])
        .theta(0.1)
        .gravity(0.05)
        .start();

 

    var edges = svg.selectAll("line")
      .data(dataset.links)
      .enter()
      .append("line")
      .attr("id",function(d,i) {return 'edge'+i})
      .attr('marker-end','url(#arrowhead)')
      .style("stroke","#ccc")
      .style("pointer-events", "none");
    
    var nodes = svg.selectAll("circle")
      .data(dataset.nodes)
      .enter().append("svg:a")
      .attr("xlink:href", function(d){return d.url;})
      .append("circle")
      .attr({"r":10})
      .style("fill",function(d,i){return colors(i);})
      .call(force.drag)
      .on("mouseover", fade(.1))
      .on("mouseout", fade(1))

    var linkedByIndex = {};
    dataset.links.forEach(function(d) {
        linkedByIndex[d.source.index + "," + d.target.index] = 1;
    });

    function isConnected(a, b) {
        return linkedByIndex[a.index + "," + b.index] || linkedByIndex[b.index + "," + a.index] || a.index == b.index;
    }


    var nodelabels = svg.selectAll(".nodelabel") 
       .data(dataset.nodes)
       .enter()
       .append("text")
       .attr({"x":function(d){return d.x;},
              "y":function(d){return d.y;},
              "class":"nodelabel",
              "stroke":"black"})
       .text(function(d){return d.id;});

    var edgepaths = svg.selectAll(".edgepath")
        .data(dataset.links)
        .enter()
        .append('path')
        .attr({'d': function(d) {return 'M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y},
               'class':'edgepath',
               'fill-opacity':0,
               'stroke-opacity':0,
               'fill':'blue',
               'stroke':'red',
               'id':function(d,i) {return 'edgepath'+i}})
        .style("pointer-events", "none");

    var edgelabels = svg.selectAll(".edgelabel")
        .data(dataset.links)
        .enter()
        .append('text')
        .style("pointer-events", "none")
        .attr({'class':'edgelabel',
               'id':function(d,i){return 'edgelabel'+i},
               'dx':80,
               'dy':0,
               'font-size':10,
               'stroke-opacity':0,
               'fill':'#aaa'});

    edgelabels.append('textPath')
        .attr('xlink:href',function(d,i) {return '#edgepath'+i})
        .style("pointer-events", "none")
        .text(function(d){return d.label});


    svg.append('defs').append('marker')
        .attr({'id':'arrowhead',
               'viewBox':'-0 -5 10 10',
               'refX':25,
               'refY':0,
               //'markerUnits':'strokeWidth',
               'orient':'auto',
               'markerWidth':10,
               'markerHeight':10,
               'xoverflow':'visible'})
        .append('svg:path')
            .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
            .attr('fill', '#ccc')
            .attr('stroke','#ccc');
     

    force.on("tick", function(){

        edges.attr({"x1": function(d){return d.source.x;},
                    "y1": function(d){return d.source.y;},
                    "x2": function(d){return d.target.x;},
                    "y2": function(d){return d.target.y;}
        });

        nodes.attr({"cx":function(d){return d.x;},
                    "cy":function(d){return d.y;}
        });

        nodelabels.attr("x", function(d) { return d.x; }) 
                  .attr("y", function(d) { return d.y; });

        edgepaths.attr('d', function(d) { var path='M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y;
                                           //console.log(d)
                                           return path});       

        edgelabels.attr('transform',function(d,i){
            if (d.target.x<d.source.x){
                bbox = this.getBBox();
                rx = bbox.x+bbox.width/2;
                ry = bbox.y+bbox.height/2;
                return 'rotate(180 '+rx+' '+ry+')';
                }
            else {
                return 'rotate(0)';
                }
        });



    });

function fade(opacity) {
        return function(d) {
            nodes.style("stroke-opacity", function(o) {
                thisOpacity = isConnected(d, o) ? 1 : opacity;
                this.setAttribute('fill-opacity', thisOpacity);
                return thisOpacity;
            });

            nodelabels.style("stroke-opacity", function(o) {
                thisOpacity = isConnected(d, o) ? 1 : opacity;
                this.setAttribute('fill-opacity', thisOpacity);
                return thisOpacity;
            });

            edges.style("stroke-opacity", function(o) {
                return o.source === d || o.target === d ? 1 : opacity;
            });

            edgelabels.style("stroke-opacity", function(o) {
                return o.source === d || o.target === d ? 1 : opacity;
            });
        };
      }

</script>

</body>
</html>